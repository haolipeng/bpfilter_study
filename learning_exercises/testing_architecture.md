# bpfilter 测试架构图解

## 1. 整体测试架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        bpfilter 测试体系                          │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐     ┌──────────────┐
│  单元测试     │      │  E2E 测试     │     │  集成测试     │
│   (unit)     │      │   (e2e)      │     │(integration) │
└──────────────┘      └──────────────┘     └──────────────┘
        │                     │                     │
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐     ┌──────────────┐
│ - 白盒测试    │      │ - 黑盒测试    │     │ - iptables   │
│ - 函数级别    │      │ - 系统级别    │     │ - nftables   │
│ - Mock 支持   │      │ - 真实 BPF   │     │ - 外部工具    │
│ - 覆盖率报告  │      │ - 真实数据包  │     │              │
└──────────────┘      └──────────────┘     └──────────────┘
```

## 2. 测试框架层次结构

```
┌─────────────────────────────────────────────────────────────────┐
│                         测试基础设施                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │              CMocka 测试框架                          │      │
│  │  - 断言宏                                             │      │
│  │  - 测试运行器                                          │      │
│  │  - Mock 支持                                          │      │
│  └──────────────────────────────────────────────────────┘      │
│                          ▲                                      │
│                          │                                      │
│  ┌──────────────────────┴───────────────────────────────┐      │
│  │           bpfilter 测试 Harness                       │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │      │
│  │  │ test.h/c   │  │ mock.h/c   │  │filters.h/c │     │      │
│  │  │ 测试定义    │  │ Mock系统   │  │ 辅助函数   │     │      │
│  │  └────────────┘  └────────────┘  └────────────┘     │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │      │
│  │  │ daemon.h/c │  │ prog.h/c   │  │process.h/c │     │      │
│  │  │ 守护进程    │  │ BPF程序    │  │ 进程管理   │     │      │
│  │  └────────────┘  └────────────┘  └────────────┘     │      │
│  └──────────────────────────────────────────────────────┘      │
│                          ▲                                      │
│                          │                                      │
│  ┌──────────────────────┴───────────────────────────────┐      │
│  │                  具体测试实现                          │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │      │
│  │  │ 单元测试    │  │ E2E 测试   │  │ CLI 测试   │     │      │
│  │  └────────────┘  └────────────┘  └────────────┘     │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 单元测试执行流程

```
┌─────────────┐
│ 编译阶段     │
└─────────────┘
      │
      │ 1. 编译测试文件（包含源文件）
      ▼
┌─────────────────────────────────────┐
│ 测试代码 + 源代码 → 单个编译单元      │
│                                     │
│ #include "libbpfilter/list.c"      │
│ #include "harness/test.h"          │
│                                     │
│ Test(list, new_and_free) { ... }   │
└─────────────────────────────────────┘
      │
      │ 2. 链接时使用 --wrap 替换函数
      ▼
┌─────────────────────────────────────┐
│ malloc  → __wrap_malloc (mock)     │
│ calloc  → __wrap_calloc (mock)     │
│ ...                                 │
└─────────────────────────────────────┘
      │
      │ 3. 测试发现（通过 ELF 段）
      ▼
┌─────────────────────────────────────┐
│ __start_bf_test                     │
│   ├─ Test(list, new_and_free)      │
│   ├─ Test(list, add_head)          │
│   └─ Test(list, add_tail)          │
│ __stop_bf_test                      │
└─────────────────────────────────────┘
      │
      │ 4. 运行测试
      ▼
┌─────────────────────────────────────┐
│ main() {                            │
│   discover_tests();                 │
│   foreach group:                    │
│     run_group_tests();              │
│   generate_coverage();              │
│ }                                   │
└─────────────────────────────────────┘
      │
      ▼
┌─────────────┐
│ 测试报告     │
│ 覆盖率报告   │
└─────────────┘
```

## 4. E2E 测试执行流程

```
┌─────────────┐
│ 准备阶段     │
└─────────────┘
      │
      │ 1. 生成测试数据包
      ▼
┌─────────────────────────────────────┐
│ genpkts.py                          │
│   → packets.h                       │
│     - pkt_local_ip4                 │
│     - pkt_local_ip6_tcp             │
│     - ...                           │
└─────────────────────────────────────┘
      │
      │ 2. 创建测试链
      ▼
┌─────────────────────────────────────┐
│ Test(ip4, saddr) {                  │
│   chain = bf_test_chain_get(        │
│     BF_HOOK_XDP,                    │
│     rules...                        │
│   );                                │
│ }                                   │
└─────────────────────────────────────┘
      │
      │ 3. 生成 BPF 程序
      ▼
┌─────────────────────────────────────┐
│ bf_codegen_generate()               │
│   → BPF 字节码                       │
└─────────────────────────────────────┘
      │
      │ 4. 加载到内核
      ▼
┌─────────────────────────────────────┐
│ bpf() 系统调用                       │
│   → 内核 BPF 验证器                  │
│   → 加载成功                         │
└─────────────────────────────────────┘
      │
      │ 5. 运行测试数据包
      ▼
┌─────────────────────────────────────┐
│ bpf_prog_test_run()                 │
│   input: test_packet                │
│   output: verdict, counters         │
└─────────────────────────────────────┘
      │
      │ 6. 验证结果
      ▼
┌─────────────────────────────────────┐
│ assert_int_equal(                   │
│   expected_verdict,                 │
│   actual_verdict                    │
│ );                                  │
│ verify_counters();                  │
└─────────────────────────────────────┘
      │
      ▼
┌─────────────┐
│ 测试通过/失败│
└─────────────┘
```

## 5. CLI 测试网络拓扑

```
┌────────────────────────────────────────────────────────────────┐
│                        主机 (Host)                              │
│                                                                │
│  ┌──────────────────┐                                         │
│  │   veth_host      │                                         │
│  │  10.0.0.1/24     │                                         │
│  └────────┬─────────┘                                         │
│           │                                                    │
│           │ veth pair                                          │
│           │                                                    │
│  ┌────────┴─────────────────────────────────────────────────┐ │
│  │              网络命名空间 (netns)                          │ │
│  │                                                            │ │
│  │  ┌──────────────────┐                                     │ │
│  │  │   veth_ns        │                                     │ │
│  │  │  10.0.0.2/24     │                                     │ │
│  │  └────────┬─────────┘                                     │ │
│  │           │                                                │ │
│  │           │ 附加 BPF 程序                                   │ │
│  │           ▼                                                │ │
│  │  ┌──────────────────┐                                     │ │
│  │  │  XDP/TC/cgroup   │                                     │ │
│  │  │    BPF 钩子      │                                     │ │
│  │  └──────────────────┘                                     │ │
│  │                                                            │ │
│  │  ┌──────────────────────────────────────┐                │ │
│  │  │         bpfilter 守护进程             │                │ │
│  │  │  - 监听 /run/bpfilter/daemon.sock    │                │ │
│  │  │  - 管理 BPF 程序                      │                │ │
│  │  │  - 处理 bfcli 请求                    │                │ │
│  │  └──────────────────────────────────────┘                │ │
│  │           ▲                                                │ │
│  │           │ Unix socket                                    │ │
│  │           │                                                │ │
│  │  ┌────────┴─────────┐                                     │ │
│  │  │      bfcli       │                                     │ │
│  │  │   (测试客户端)    │                                     │ │
│  │  └──────────────────┘                                     │ │
│  │                                                            │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘

测试流程：
1. 从主机 ping 10.0.0.2
2. 数据包进入 veth_ns
3. BPF 程序处理数据包
4. 验证结果（DROP/ACCEPT）
5. 检查计数器
```

## 6. Mock 系统工作原理

```
┌─────────────────────────────────────────────────────────────────┐
│                      编译时 (CMakeLists.txt)                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ bf_test_mock(unit_bin FUNCTIONS malloc)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    链接器选项: -Wl,--wrap=malloc                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐     ┌──────────────┐
│ 测试代码      │      │ 源代码        │     │ Mock 实现     │
└──────────────┘      └──────────────┘     └──────────────┘
        │                     │                     │
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐     ┌──────────────┐
│ mock =       │      │ ptr =        │     │ void *       │
│ bf_test_mock │      │ malloc(100); │     │ __wrap_malloc│
│ _get(malloc, │      │              │     │ (size_t size)│
│      NULL);  │      │              │     │ {            │
│              │      │              │     │   if (enabled│
└──────────────┘      └──────────────┘     │     return   │
                                            │     mock();  │
                                            │   return     │
                                            │   __real_    │
                                            │   malloc();  │
                                            │ }            │
                                            └──────────────┘

运行时符号解析：
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  malloc() 调用                                                  │
│      │                                                          │
│      ├─ Mock 未启用 ──→ __real_malloc() ──→ libc malloc()      │
│      │                                                          │
│      └─ Mock 已启用 ──→ __wrap_malloc() ──→ 返回 mock 值       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 7. 测试发现机制

```
┌─────────────────────────────────────────────────────────────────┐
│                      编译时                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Test(group, name) 宏展开
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ bf_test __attribute__((section("bf_test"))) test_obj = {        │
│     .group_name = "group",                                      │
│     .test_name = "name",                                        │
│     .cb = &group__name                                          │
│ };                                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 链接器收集所有 bf_test 段
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ELF 文件布局                                │
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  .text (代码段)                                         │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │  .data (数据段)                                         │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │  .bf_test (测试段)                                      │    │
│  │    ┌──────────────────────────────────────────┐        │    │
│  │    │ __start_bf_test (链接器生成的符号)        │        │    │
│  │    ├──────────────────────────────────────────┤        │    │
│  │    │ test_obj_1 (list, new_and_free)          │        │    │
│  │    ├──────────────────────────────────────────┤        │    │
│  │    │ test_obj_2 (list, add_head)              │        │    │
│  │    ├──────────────────────────────────────────┤        │    │
│  │    │ test_obj_3 (matcher, ip4_saddr)          │        │    │
│  │    ├──────────────────────────────────────────┤        │    │
│  │    │ ...                                       │        │    │
│  │    ├──────────────────────────────────────────┤        │    │
│  │    │ __stop_bf_test (链接器生成的符号)         │        │    │
│  │    └──────────────────────────────────────────┘        │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 运行时
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ int main() {                                                    │
│     extern bf_test __start_bf_test;                             │
│     extern bf_test __stop_bf_test;                              │
│                                                                 │
│     bf_test_discover_test_suite(&suite,                         │
│                                 &__start_bf_test,               │
│                                 &__stop_bf_test);               │
│                                                                 │
│     // 遍历所有测试                                              │
│     for (test = &__start_bf_test;                               │
│          test < &__stop_bf_test;                                │
│          ++test) {                                              │
│         add_test_to_suite(suite, test);                         │
│     }                                                           │
│ }                                                               │
└─────────────────────────────────────────────────────────────────┘
```

## 8. 代码覆盖率生成流程

```
┌─────────────┐
│ 编译阶段     │
└─────────────┘
      │
      │ -ftest-coverage -fprofile-arcs
      ▼
┌─────────────────────────────────────┐
│ 源代码 + 插桩代码                     │
│   每个分支、语句都有计数器             │
└─────────────────────────────────────┘
      │
      │ 运行测试
      ▼
┌─────────────────────────────────────┐
│ 生成 .gcda 文件                      │
│   记录每个计数器的执行次数             │
└─────────────────────────────────────┘
      │
      │ lcov --capture
      ▼
┌─────────────────────────────────────┐
│ 收集覆盖率数据                        │
│   .gcno (编译时) + .gcda (运行时)    │
│   → lcov.info                       │
└─────────────────────────────────────┘
      │
      │ lcov --extract
      ▼
┌─────────────────────────────────────┐
│ 过滤只保留源代码的覆盖率               │
│   排除测试代码、系统头文件             │
└─────────────────────────────────────┘
      │
      │ genhtml
      ▼
┌─────────────────────────────────────┐
│ 生成 HTML 报告                       │
│   - 文件级覆盖率                      │
│   - 函数级覆盖率                      │
│   - 行级覆盖率                        │
│   - 分支覆盖率                        │
└─────────────────────────────────────┘
```

## 9. 测试数据流

```
┌──────────────────────────────────────────────────────────────┐
│                       测试输入                                │
└──────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ 测试数据包    │   │ 测试规则      │   │ Mock 配置     │
│ (packets.h)  │   │ (rules)      │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                      被测系统                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ 解析规则    │→ │ 生成代码    │→ │ 加载 BPF   │            │
│  └────────────┘  └────────────┘  └────────────┘            │
│                           │                                  │
│                           ▼                                  │
│                  ┌────────────────┐                          │
│                  │  执行 BPF 程序  │                          │
│                  └────────────────┘                          │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                       测试输出                                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ 裁决结果    │  │ 计数器值    │  │ 日志输出    │            │
│  │ (verdict)  │  │ (counters) │  │ (logs)     │            │
│  └────────────┘  └────────────┘  └────────────┘            │
└──────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│                       验证                                    │
│  assert_int_equal(expected_verdict, actual_verdict);         │
│  assert_counter_equal(expected_counter, actual_counter);     │
└──────────────────────────────────────────────────────────────┘
```

## 总结

bpfilter 的测试架构具有以下特点：

1. **分层设计**：从底层 CMocka 到上层测试实现，层次清晰
2. **自动发现**：通过 ELF 段自动发现测试，无需手动注册
3. **Mock 灵活**：使用链接器 `--wrap` 实现函数替换
4. **真实环境**：E2E 测试使用真实的 BPF 程序和内核
5. **完整覆盖**：从单元到集成，全方位测试
6. **CI 友好**：所有测试可自动化运行

这种架构确保了代码质量和系统可靠性。
