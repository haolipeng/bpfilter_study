# bpfilter å­¦ä¹ ç»ƒä¹ 

æ¬¢è¿æ¥åˆ° bpfilter çš„å®è·µç»ƒä¹ ï¼è¿™ä¸ªç›®å½•åŒ…å«äº†ä¸€ç³»åˆ—æ¸è¿›å¼çš„ç»ƒä¹ ï¼Œå¸®åŠ©ä½ ä»é›¶å¼€å§‹æŒæ¡ bpfilterã€‚

## ğŸ“š ç»ƒä¹ åˆ—è¡¨

### Exercise 1: åŸºç¡€è§„åˆ™å’ŒåŒ¹é…å™¨ â­
**æ–‡ä»¶ï¼š** `exercise_01_basic.bf`
**å­¦ä¹ å†…å®¹ï¼š**
- Chainã€Ruleã€Matcherã€Verdict åŸºæœ¬æ¦‚å¿µ
- IP åœ°å€åŒ¹é…ï¼ˆsaddrã€daddrã€snetã€dnetï¼‰
- åè®®åŒ¹é…ï¼ˆtcpã€udpã€icmpï¼‰
- Counter å’Œ Log çš„åŸºç¡€ç”¨æ³•

**é¢„è®¡æ—¶é—´ï¼š** 1-2 å°æ—¶

---

### Exercise 2: ç«¯å£è¿‡æ»¤å’Œä¼ è¾“å±‚åŒ¹é… â­â­
**æ–‡ä»¶ï¼š** `exercise_02_ports.bf`
**å­¦ä¹ å†…å®¹ï¼š**
- TCP/UDP ç«¯å£åŒ¹é…ï¼ˆsportã€dportï¼‰
- ç»„åˆå¤šä¸ªåŒ¹é…å™¨
- ä¸åŒ Hook ç±»å‹ï¼ˆLOCAL_INã€LOCAL_OUTï¼‰
- å®é™…é˜²ç«å¢™åœºæ™¯ï¼ˆSSH ä¿æŠ¤ã€Web æœåŠ¡å™¨ï¼‰

**é¢„è®¡æ—¶é—´ï¼š** 2-3 å°æ—¶

---

### Exercise 3: ä½¿ç”¨ Set è¿›è¡Œæ‰¹é‡åŒ¹é… â­â­â­
**æ–‡ä»¶ï¼š** `exercise_03_sets.bf`
**å­¦ä¹ å†…å®¹ï¼š**
- Set çš„å®šä¹‰å’Œä½¿ç”¨
- å‘½å Set vs åŒ¿å Set
- IP é»‘åå•/ç™½åå•
- ç«¯å£é›†åˆç®¡ç†
- æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**é¢„è®¡æ—¶é—´ï¼š** 2-3 å°æ—¶

---

### Exercise 4: æµé‡ç»Ÿè®¡å’Œç›‘æ§ â­â­
**æ–‡ä»¶ï¼š** `exercise_04_counters.bf`
**å­¦ä¹ å†…å®¹ï¼š**
- Counter æ·±åº¦ä½¿ç”¨
- Log çº§åˆ«ï¼ˆnoneã€metaã€transportï¼‰
- æµé‡åˆ†æå’Œç›‘æ§
- å®‰å…¨äº‹ä»¶è®°å½•
- å¸¦å®½ç›‘æ§æŠ€å·§

**é¢„è®¡æ—¶é—´ï¼š** 2-3 å°æ—¶

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨è¿™äº›ç»ƒä¹ 

### 1. å‡†å¤‡ç¯å¢ƒ

é¦–å…ˆç¡®ä¿å·²ç»ç¼–è¯‘äº† bpfilterï¼š

```bash
cd /home/work/bpfilter
cmake -S . -B build -DNO_DOCS=ON -DNO_CHECKS=ON -DNO_BENCHMARKS=ON
make -C build
```

### 2. å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹

åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼š

```bash
sudo build/output/sbin/bpfilter --transient -v
```

- `--transient`: æµ‹è¯•æ¨¡å¼ï¼Œä¸æŒä¹…åŒ–é…ç½®
- `-v`: è¯¦ç»†æ—¥å¿—æ¨¡å¼

### 3. è¿è¡Œç»ƒä¹ 

åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­åŠ è½½ç»ƒä¹ æ–‡ä»¶ï¼š

```bash
# åŠ è½½ç»ƒä¹  1
sudo build/output/sbin/bfcli ruleset set --from-file learning_exercises/exercise_01_basic.bf

# æŸ¥çœ‹åŠ è½½çš„è§„åˆ™
sudo build/output/sbin/bfcli ruleset get

# æµ‹è¯•è§„åˆ™...ï¼ˆæ ¹æ®ç»ƒä¹ æ–‡ä»¶ä¸­çš„è¯´æ˜ï¼‰

# æ¸…ç©ºè§„åˆ™ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªç»ƒä¹ 
sudo build/output/sbin/bfcli ruleset flush
```

### 4. éªŒè¯è§„åˆ™

æ¯ä¸ªç»ƒä¹ æ–‡ä»¶éƒ½åŒ…å«äº†æµ‹è¯•æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

```bash
# æµ‹è¯• ICMP è§„åˆ™
ping <your-machine-ip>  # ä»å…¶ä»–æœºå™¨æ‰§è¡Œ

# æŸ¥çœ‹ counter æ˜¯å¦å¢åŠ 
sudo build/output/sbin/bfcli ruleset get

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u bpfilter -f
```

## ğŸ“– å­¦ä¹ è·¯å¾„å»ºè®®

### ç¬¬ä¸€å‘¨ï¼šåŸºç¡€æŒæ¡
- **Day 1-2:** Exercise 1ï¼ˆåŸºç¡€è§„åˆ™ï¼‰
- **Day 3-4:** Exercise 2ï¼ˆç«¯å£è¿‡æ»¤ï¼‰
- **Day 5:** å¤ä¹ å’Œå®è·µ

### ç¬¬äºŒå‘¨ï¼šè¿›é˜¶æŠ€èƒ½
- **Day 1-2:** Exercise 3ï¼ˆSet ä½¿ç”¨ï¼‰
- **Day 3-4:** Exercise 4ï¼ˆæµé‡ç›‘æ§ï¼‰
- **Day 5:** ç»¼åˆå®æˆ˜é¡¹ç›®

### å®æˆ˜é¡¹ç›®å»ºè®®

å®ŒæˆåŸºç¡€ç»ƒä¹ åï¼Œå°è¯•ä»¥ä¸‹é¡¹ç›®ï¼š

1. **å®¶åº­ç½‘å…³é˜²ç«å¢™**
   - ä¿æŠ¤å†…ç½‘ä¸»æœº
   - é™åˆ¶å‡ºç«™æµé‡
   - ç»Ÿè®¡æµé‡ä½¿ç”¨

2. **Web æœåŠ¡å™¨é˜²æŠ¤**
   - åªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80ã€443ã€22ï¼‰
   - IP ç™½åå•
   - DDoS åŸºç¡€é˜²æŠ¤

3. **ä¼ä¸šè¾¹ç•Œé˜²ç«å¢™**
   - åˆ†åŒºç®¡ç†ï¼ˆDMZã€å†…ç½‘ã€ç®¡ç†ç½‘ï¼‰
   - æœåŠ¡ç«¯å£æ§åˆ¶
   - æµé‡å®¡è®¡å’Œæ—¥å¿—

## ğŸ”§ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# ä»æ–‡ä»¶åŠ è½½è§„åˆ™
sudo build/output/sbin/bfcli ruleset set --from-file <file.bf>

# ä»å­—ç¬¦ä¸²åŠ è½½è§„åˆ™
sudo build/output/sbin/bfcli ruleset set --from-str "chain test BF_HOOK_NF_LOCAL_IN ACCEPT ..."

# æŸ¥çœ‹å½“å‰è§„åˆ™é›†
sudo build/output/sbin/bfcli ruleset get

# æ¸…ç©ºæ‰€æœ‰è§„åˆ™
sudo build/output/sbin/bfcli ruleset flush

# æŸ¥çœ‹å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—
sudo journalctl -u bpfilter -f

# æŸ¥çœ‹å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€
ps aux | grep bpfilter
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šå®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥æ˜¯å¦å·²æœ‰å®ä¾‹è¿è¡Œ
ps aux | grep bpfilter | grep -v grep

# å¦‚æœæœ‰ï¼Œå…ˆåœæ­¢
sudo pkill bpfilter

# é‡æ–°å¯åŠ¨
sudo build/output/sbin/bpfilter --transient
```

### é—®é¢˜ 2ï¼šè§„åˆ™åŠ è½½å¤±è´¥

- æ£€æŸ¥è§„åˆ™æ–‡ä»¶è¯­æ³•
- æŸ¥çœ‹å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—ï¼š`sudo journalctl -u bpfilter -n 50`
- ä½¿ç”¨ `-v` å‚æ•°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 3ï¼šè§„åˆ™ä¸ç”Ÿæ•ˆ

- ç¡®è®¤å®ˆæŠ¤è¿›ç¨‹æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ Hook ç±»å‹æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹ counter æ˜¯å¦å¢åŠ ï¼ˆè¯æ˜è§„åˆ™è¢«åŒ¹é…ï¼‰
- ç¡®è®¤é»˜è®¤ç­–ç•¥æ˜¯å¦ç¬¦åˆé¢„æœŸ

### é—®é¢˜ 4ï¼šæ— æ³•çœ‹åˆ°æ—¥å¿—

```bash
# ä½¿ç”¨ verbose æ¨¡å¼å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
sudo build/output/sbin/bpfilter --transient -v

# æˆ–æŒ‡å®šè¾“å‡ºåˆ° syslog
sudo build/output/sbin/bpfilter --transient --syslog

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/syslog | grep bpfilter
```

## ğŸ“š è¿›é˜¶å­¦ä¹ èµ„æº

å®Œæˆè¿™äº›ç»ƒä¹ åï¼Œä½ å¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **é˜…è¯»å®é™…ç¤ºä¾‹**
   - `tests/e2e/rulesets/` - å„ç§ Hook çš„å®Œæ•´ç¤ºä¾‹
   - `tests/rules.bpfilter` - æ‰€æœ‰åŠŸèƒ½çš„ç»¼åˆç¤ºä¾‹

2. **å­¦ä¹  API ç¼–ç¨‹**
   - `src/libbpfilter/include/bpfilter/bpfilter.h` - API å®šä¹‰
   - `src/bfcli/main.c` - CLI å·¥å…·å®ç°ï¼ˆAPI ç”¨æ³•ç¤ºä¾‹ï¼‰

3. **æ·±å…¥å†…éƒ¨å®ç°**
   - `src/bfcli/lexer.l` å’Œ `parser.y` - è§„åˆ™è§£æ
   - `src/bpfilter/cgen/` - BPF ä»£ç ç”Ÿæˆ
   - `src/bpfilter/xlate/` - ç¿»è¯‘å±‚å®ç°

4. **è¿è¡Œæµ‹è¯•**
   ```bash
   # è¿è¡Œå•å…ƒæµ‹è¯•
   make -C build unit

   # è¿è¡Œ E2E æµ‹è¯•
   make -C build e2e

   # è¿è¡Œé›†æˆæµ‹è¯•
   make -C build integration
   ```

5. **é˜…è¯»æ–‡æ¡£**
   - [doc/usage/bfcli.rst](../doc/usage/bfcli.rst) - å®Œæ•´å‘½ä»¤å‚è€ƒ
   - [doc/developers/](../doc/developers/) - å¼€å‘è€…æ–‡æ¡£
   - https://bpfilter.io/ - å®˜æ–¹æ–‡æ¡£ç½‘ç«™

## ğŸ’¡ å­¦ä¹ æŠ€å·§

1. **è¾¹å­¦è¾¹åš**ï¼šæ¯çœ‹åˆ°ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œç«‹å³ç”¨ bfcli æµ‹è¯•
2. **è®°å½•ç¬”è®°**ï¼šè®°å½•é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•
3. **å®éªŒå˜ä½“**ï¼šä¿®æ”¹ç¤ºä¾‹è§„åˆ™ï¼Œè§‚å¯Ÿè¡Œä¸ºå˜åŒ–
4. **é˜…è¯»æ—¥å¿—**ï¼šä½¿ç”¨ `-v` å’Œ `log` ç†è§£è§„åˆ™æ‰§è¡Œè¿‡ç¨‹
5. **å‚è€ƒæµ‹è¯•**ï¼š`tests/` ç›®å½•æ˜¯æœ€å¥½çš„å­¦ä¹ ææ–™

## ğŸ¯ è¯„ä¼°æ ‡å‡†

å®Œæˆæ¯ä¸ªç»ƒä¹ åï¼Œç¡®ä¿ä½ èƒ½å¤Ÿï¼š

### Exercise 1
- [ ] ç‹¬ç«‹ç¼–å†™åŸºç¡€è§„åˆ™
- [ ] ç†è§£ Chain çš„ç»“æ„å’Œä½œç”¨
- [ ] ä½¿ç”¨ counter éªŒè¯è§„åˆ™
- [ ] ç†è§£ä¸åŒåˆ¤å†³ï¼ˆACCEPTã€DROPï¼‰çš„å«ä¹‰

### Exercise 2
- [ ] ç¼–å†™ç«¯å£è¿‡æ»¤è§„åˆ™
- [ ] ç»„åˆå¤šä¸ªåŒ¹é…å™¨
- [ ] ç†è§£ä¸åŒ Hook çš„åŒºåˆ«
- [ ] å®ç°ç®€å•çš„é˜²ç«å¢™é…ç½®

### Exercise 3
- [ ] åˆ›å»ºå’Œä½¿ç”¨ Set
- [ ] ç†è§£ Set çš„æ€§èƒ½ä¼˜åŠ¿
- [ ] ç¼–å†™å¤§è§„æ¨¡ IP é»‘åå•
- [ ] ä½¿ç”¨ Set ä¼˜åŒ–è§„åˆ™ç»“æ„

### Exercise 4
- [ ] ä½¿ç”¨ counter æ”¶é›†æµé‡ç»Ÿè®¡
- [ ] é…ç½®ä¸åŒçº§åˆ«çš„ log
- [ ] åˆ†ææµé‡æ¨¡å¼
- [ ] å®ç°ç›‘æ§å’Œå‘Šè­¦

## ğŸ¤ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ç»ƒä¹ æ–‡ä»¶ä¸­çš„æ³¨é‡Šå’Œæç¤º
2. é˜…è¯» [LEARNING_QUICKSTART.md](../LEARNING_QUICKSTART.md)
3. æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://bpfilter.io/
4. ç ”ç©¶ `tests/` ç›®å½•ä¸­çš„ç¤ºä¾‹
5. æŸ¥çœ‹ GitHub Issuesï¼šhttps://github.com/facebook/bpfilter/issues

## ğŸ“ å­¦ä¹ è®°å½•

å»ºè®®åˆ›å»ºä¸€ä¸ªå­¦ä¹ æ—¥å¿—ï¼Œè®°å½•ï¼š

- å®Œæˆçš„ç»ƒä¹ å’Œæ—¥æœŸ
- é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•
- è‡ªå·±ç¼–å†™çš„è§„åˆ™ç¤ºä¾‹
- æ€§èƒ½æµ‹è¯•ç»“æœ
- æ–°çš„å‘ç°å’Œæƒ³æ³•

ç¤ºä¾‹æ ¼å¼ï¼š
```
## 2025-10-31

### å®Œæˆ
- Exercise 1: åŸºç¡€è§„åˆ™
- Exercise 2: ç«¯å£è¿‡æ»¤ï¼ˆ50%ï¼‰

### å­¦ä¹ ç¬”è®°
- Counter å¯ä»¥ç»Ÿè®¡åŒ…æ•°å’Œå­—èŠ‚æ•°
- ICMP åè®®å€¼æ˜¯ 1
- é»˜è®¤ç­–ç•¥å¾ˆé‡è¦

### é—®é¢˜
- Q: å¦‚ä½•åŒ¹é…ç«¯å£èŒƒå›´ï¼Ÿ
- A: æŸ¥çœ‹æ–‡æ¡£åå‘ç°...

### ä¸‹ä¸€æ­¥
- å®Œæˆ Exercise 2
- å°è¯•ç¼–å†™ SSH ä¿æŠ¤è§„åˆ™
```

ç¥å­¦ä¹ æ„‰å¿«ï¼ğŸš€
